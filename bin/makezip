#!/usr/bin/env bash
set -euo pipefail && cd "$(dirname "${BASH_SOURCE[0]}")/.."

abspath() {
    python -c "import os,sys; print os.path.abspath(sys.argv[1])" "$1"
}

target=$(abspath srv/main.zip)

rm -f "$target"

pushd main/lib
zip -X -r "$target" --exclude='*.pyc' .
popd

pushd third_party
zip -X -r "$target" --exclude='*.pyc' .
popd

stripzip "$target"

sha=$(shasum "$target" | cut -f 1 -d " ")

echo "$sha"

sed "s/SHA_GOES_HERE/$sha/" < bin/mothg_template > bin/mothg
chmod +x bin/mothg
